import re, struct
from dataclasses import dataclass, fields, field

def unpack(type, data: str | bytes):
    if isinstance(data, str):
        data = bytes.fromhex(data)
    formats = type.FORMAT.split("-")
    assert len(formats) == len(fields(type))

    obj = type()
    for i, field in enumerate(fields(type)):
        m = re.match(r"[iu](\d+)$", formats[i])
        if not m:
            cls = globals()[formats[i]]
            val = unpack(cls, data)
            size = val.size()
        else:
            size = int(m.group(1)) // 8
            signed = formats[i][0] == "i"
            val = int.from_bytes(data[:size], byteorder="big", signed=signed)
        setattr(obj, field.name, val)
        data = data[size:]
    return obj


def unpack_array(type, data: str | bytes):
    if isinstance(data, str):
        data = bytes.fromhex(data)
    size = struct.unpack(">I", data[:4])[0]
    items = []
    data = data[4:]
    while len(data) != 0:
        obj = unpack(type, data)
        items.append(obj)
        data = data[obj.size():]
    assert size == len(items)
    return items


def pack(obj):
    formats = obj.FORMAT.split("-")
    data = b""
    for i, field in enumerate(fields(obj.__class__)):
        val = getattr(obj, field.name)
        if m := re.match(r"[iu](\d+)$", formats[i]):
            size = int(m.group(1)) // 8
            signed = formats[i][0] == "i"
            data += val.to_bytes(size, byteorder="big", signed=signed)
        elif formats[i] == 'array':
            pass
        else:
            data += pack(val)
    return data


def dump(obj, indent="  "):
    formats = obj.FORMAT.split("-")
    for i, field in enumerate(fields(obj.__class__)):
        val = getattr(obj, field.name)
        if m := re.match(r"[iu](\d+)$", formats[i]):
            print(f"{indent}{field.name}: {val}")
        else:
            print(f"{indent}{field.name}: ")
            dump(val, indent + "  ")


% MSG_FORMAT = "i8-u256-i8-u256-u64"
#@dataclass
#class Message:
#    wc_from: int = 0xff
#    addr_from: int | None = None
#    wc_to: int = 0xff
#    addr_to: int | None = None
#    amount: int | None = None
#    FORMAT = "<%= MSG_FORMAT %>"

#    def size(self):
#        return <%= MSG_FORMAT.scan(/\d+/).map(&:to_i).sum / 8 %>

#    def pack(self):
#        return pack(self)

% ir.types.select{ _2.is_a?(StructType) && !_2.descr['flags']&.include?("storage") }.each do |name, type|

@dataclass
class <%= name %>:
%   if type.descr['flags']&.include?("message")
%    # msg = "Message-"
    # message_header: Message | None = None
%   end
%   type.fields.each do |field|
    <%= field.name %>: <%= field.type.python_name %> | None = None
%   end
%   format = type.fields.map { _1.type.container?() ? 'array' : _1.type.name }
    FORMAT = "<%= format.join('-') %>"
% #    FORMAT = "<%= type.fields.map(&:type).map(&:name).join('-') %>"

    def size(self):
        sz = <%= type.fields.select{ !_1.type.is_a?(ContainerType) }.map(&:type).sum(&:bytes_size) %>
%   type.fields.select{ _1.type.is_a?(ContainerType) }.each do |field|
        sz += sum(x.size() for x in self.<%= field.name %>)
%   end
        return sz

    def pack(self):
        return pack(self)
% end